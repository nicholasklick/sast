# Python Core Taint Configuration
# Base sources, sinks, and sanitizers for Python applications

sources:
  # Standard Input
  - name: "input"
    kind: UserInput
    description: "Read user input"

  - name: "raw_input"
    kind: UserInput
    description: "Read user input (Python 2)"

  - name: "sys.argv"
    kind: UserInput
    description: "Command line arguments"

  - name: "sys.stdin"
    kind: UserInput
    description: "Standard input stream"

  - name: "sys.stdin.read"
    kind: UserInput
    description: "Read from stdin"

  - name: "sys.stdin.readline"
    kind: UserInput
    description: "Read line from stdin"

  # File I/O
  - name: "open"
    kind: File
    description: "Open file"

  - name: "read"
    kind: File
    description: "Read file contents"

  - name: "readline"
    kind: File
    description: "Read line from file"

  - name: "readlines"
    kind: File
    description: "Read all lines from file"

  - name: "Path.read_text"
    kind: File
    package: "pathlib"
    description: "Read file as text"

  - name: "Path.read_bytes"
    kind: File
    package: "pathlib"
    description: "Read file as bytes"

  # Environment
  - name: "os.environ"
    kind: Environment
    description: "Environment variables dict"

  - name: "os.environ.get"
    kind: Environment
    description: "Get environment variable"

  - name: "os.getenv"
    kind: Environment
    description: "Get environment variable"

  # Network
  - name: "requests.get"
    kind: Network
    description: "HTTP GET request"

  - name: "requests.post"
    kind: Network
    description: "HTTP POST request"

  - name: "urllib.request.urlopen"
    kind: Network
    description: "URL open"

  - name: "httpx.get"
    kind: Network
    description: "HTTPX GET request"

  # Flask HTTP Sources
  - name: "request.args"
    kind: UserInput
    description: "Flask query parameters"

  - name: "request.args.get"
    kind: UserInput
    description: "Flask query parameter getter"

  - name: "request.form"
    kind: UserInput
    description: "Flask form data"

  - name: "request.form.get"
    kind: UserInput
    description: "Flask form data getter"

  - name: "request.data"
    kind: UserInput
    description: "Flask raw request data"

  - name: "request.json"
    kind: UserInput
    description: "Flask JSON body"

  - name: "request.cookies"
    kind: UserInput
    description: "Flask cookies"

  - name: "request.cookies.get"
    kind: UserInput
    description: "Flask cookie getter"

  - name: "request.headers"
    kind: UserInput
    description: "Flask request headers"

  - name: "request.headers.get"
    kind: UserInput
    description: "Flask header getter"

  - name: "request.headers.getlist"
    kind: UserInput
    description: "Flask headers getlist"

  - name: "request.args.getlist"
    kind: UserInput
    description: "Flask args getlist"

  - name: "request.form.getlist"
    kind: UserInput
    description: "Flask form getlist"

  - name: "request.values.getlist"
    kind: UserInput
    description: "Flask values getlist"

  - name: "request.values"
    kind: UserInput
    description: "Flask combined args/form"

  - name: "request.values.get"
    kind: UserInput
    description: "Flask combined getter"

  - name: "request.files"
    kind: UserInput
    description: "Flask uploaded files"

  # Django HTTP Sources
  - name: "request.GET"
    kind: UserInput
    description: "Django GET parameters"

  - name: "request.GET.get"
    kind: UserInput
    description: "Django GET parameter getter"

  - name: "request.POST"
    kind: UserInput
    description: "Django POST parameters"

  - name: "request.POST.get"
    kind: UserInput
    description: "Django POST parameter getter"

  - name: "request.COOKIES"
    kind: UserInput
    description: "Django cookies"

  - name: "request.COOKIES.get"
    kind: UserInput
    description: "Django cookie getter"

  - name: "request.META"
    kind: UserInput
    description: "Django request metadata"

  - name: "request.body"
    kind: UserInput
    description: "Django raw body"

sinks:
  # SQL Injection
  - name: "execute"
    kind: SqlQuery
    description: "Execute SQL query"
    argument: 0

  - name: "executemany"
    kind: SqlQuery
    description: "Execute many SQL queries"
    argument: 0

  - name: "cursor.execute"
    kind: SqlQuery
    description: "Cursor execute SQL"
    argument: 0

  - name: "conn.execute"
    kind: SqlQuery
    description: "Connection execute SQL"
    argument: 0

  - name: "session.execute"
    kind: SqlQuery
    description: "SQLAlchemy session execute"
    argument: 0

  - name: "engine.execute"
    kind: SqlQuery
    description: "SQLAlchemy engine execute"
    argument: 0

  - name: "raw"
    kind: SqlQuery
    description: "Raw SQL query"
    argument: 0

  - name: "text"
    kind: SqlQuery
    package: "sqlalchemy"
    description: "SQLAlchemy text SQL"
    argument: 0

  # Command Execution
  - name: "os.system"
    kind: CommandExecution
    description: "Execute system command"
    argument: 0

  - name: "os.popen"
    kind: CommandExecution
    description: "Open pipe to command"
    argument: 0

  - name: "subprocess.call"
    kind: CommandExecution
    description: "Call subprocess"
    argument: 0

  - name: "subprocess.run"
    kind: CommandExecution
    description: "Run subprocess"
    argument: 0

  - name: "subprocess.Popen"
    kind: CommandExecution
    description: "Popen subprocess"
    argument: 0

  - name: "subprocess.check_call"
    kind: CommandExecution
    description: "Check call subprocess"
    argument: 0

  - name: "subprocess.check_output"
    kind: CommandExecution
    description: "Check output subprocess"
    argument: 0

  # Code Injection
  - name: "eval"
    kind: CodeEval
    description: "Evaluate Python expression"
    argument: 0

  - name: "exec"
    kind: CodeEval
    description: "Execute Python code"
    argument: 0

  - name: "compile"
    kind: CodeEval
    description: "Compile code object"
    argument: 0

  - name: "__import__"
    kind: CodeEval
    description: "Dynamic import"
    argument: 0

  - name: "importlib.import_module"
    kind: CodeEval
    description: "Import module dynamically"
    argument: 0

  # File operations
  - name: "open"
    kind: PathTraversal
    description: "Open file (path traversal risk)"
    argument: 0

  - name: "codecs.open"
    kind: PathTraversal
    description: "Codecs open file (path traversal risk)"
    argument: 0

  - name: "io.open"
    kind: PathTraversal
    description: "IO open file (path traversal risk)"
    argument: 0

  - name: "os.path.join"
    kind: PathTraversal
    description: "Join paths"
    argument: 1

  - name: "pathlib.Path"
    kind: PathTraversal
    description: "Pathlib path (path traversal risk)"
    argument: 0

  - name: "Path"
    kind: PathTraversal
    description: "Path constructor (path traversal risk)"
    argument: 0

  - name: "shutil.copy"
    kind: FileWrite
    description: "Copy file"

  - name: "shutil.move"
    kind: FileWrite
    description: "Move file"

  - name: "os.remove"
    kind: FileWrite
    description: "Remove file"

  - name: "os.unlink"
    kind: FileWrite
    description: "Unlink file"

  - name: "os.rmdir"
    kind: FileWrite
    description: "Remove directory"

  # Deserialization
  - name: "pickle.loads"
    kind: Deserialization
    description: "Unpickle object"
    argument: 0

  - name: "pickle.load"
    kind: Deserialization
    description: "Unpickle from file"
    argument: 0

  - name: "yaml.load"
    kind: Deserialization
    description: "Load YAML (unsafe)"
    argument: 0

  - name: "yaml.unsafe_load"
    kind: Deserialization
    description: "Unsafe YAML load"
    argument: 0

  - name: "marshal.loads"
    kind: Deserialization
    description: "Unmarshal object"
    argument: 0

  # XSS - Only clearly dangerous methods
  # Note: Markup is NOT a sink - markupsafe.escape() returns Markup which is safe
  # mark_safe marks untrusted input as safe WITHOUT escaping (dangerous)
  - name: "render_template_string"
    kind: HtmlOutput
    description: "Render template from string (dangerous)"
    argument: 0

  - name: "mark_safe"
    kind: HtmlOutput
    package: "django.utils.safestring"
    description: "Mark string as safe HTML (dangerous if untrusted)"
    argument: 0

  # SSRF
  - name: "urllib.request.urlopen"
    kind: NetworkSend
    description: "Open URL (SSRF risk)"
    argument: 0

  - name: "requests.get"
    kind: NetworkSend
    description: "HTTP GET (SSRF risk)"
    argument: 0

  # LDAP Injection
  - name: "search"
    kind: LdapQuery
    description: "LDAP search query (ldap3)"
    argument: 1

  - name: "conn.search"
    kind: LdapQuery
    description: "LDAP connection search (ldap3)"
    argument: 1

  - name: "search_s"
    kind: LdapQuery
    description: "LDAP synchronous search (python-ldap)"
    argument: 1

  - name: "search_st"
    kind: LdapQuery
    description: "LDAP search with timeout (python-ldap)"
    argument: 1

  - name: "search_ext"
    kind: LdapQuery
    description: "LDAP extended search (python-ldap)"
    argument: 1

  - name: "search_ext_s"
    kind: LdapQuery
    description: "LDAP extended synchronous search (python-ldap)"
    argument: 1

sanitizers:
  # HTML sanitization
  - name: "escape"
    sanitizes: [Html]
    description: "Generic escape"

  - name: "html.escape"
    sanitizes: [Html]
    description: "HTML escape"

  - name: "cgi.escape"
    sanitizes: [Html]
    description: "CGI HTML escape"

  - name: "markupsafe.escape"
    sanitizes: [Html]
    description: "MarkupSafe HTML escape"

  - name: "bleach.clean"
    sanitizes: [Html]
    description: "Bleach HTML sanitizer"

  # Shell sanitization
  - name: "shlex.quote"
    sanitizes: [Shell]
    description: "Shell quote"

  - name: "pipes.quote"
    sanitizes: [Shell]
    description: "Pipes shell quote"

  # Type conversion (sanitizes all)
  - name: "int"
    sanitizes: [All]
    description: "Convert to integer"

  - name: "float"
    sanitizes: [All]
    description: "Convert to float"

  - name: "str"
    sanitizes: [All]
    description: "Convert to string"

summaries:
  # String operations
  - name: "+"
    package: "str"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "join"
    package: "str"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "format"
    package: "str"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "lower"
    package: "str"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "upper"
    package: "str"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "strip"
    package: "str"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "split"
    package: "str"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "replace"
    package: "str"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  # List/Dict access
  - name: "[]"
    package: "list"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "get"
    package: "dict"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  # URL decoding
  - name: "unquote"
    package: "urllib.parse"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: value

  # Base64 decoding
  - name: "b64decode"
    package: "base64"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: value

  # JSON parsing - taint flows from input string to parsed object
  - name: "json.loads"
    package: "json"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "json.load"
    package: "json"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "loads"
    package: "json"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "load"
    package: "json"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # YAML parsing (safe loader is a sanitizer, not listed here)
  - name: "yaml.safe_load"
    package: "yaml"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # XML parsing
  - name: "fromstring"
    package: "xml.etree.ElementTree"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "parse"
    package: "xml.etree.ElementTree"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # configparser
  - name: "read_string"
    package: "configparser"
    input: "Argument[0]"
    output: "Argument[this]"
    kind: taint

# =============================================================================
# SQLAlchemy ORM Framework
# =============================================================================

additional_sinks_sqlalchemy:
  # SQLAlchemy text() - raw SQL (primary injection risk)
  - name: "text"
    kind: SqlQuery
    package: "sqlalchemy"
    description: "SQLAlchemy raw SQL text"
    argument: 0

  - name: "sqlalchemy.text"
    kind: SqlQuery
    description: "SQLAlchemy raw SQL text"
    argument: 0

  # SQLAlchemy Session/Engine execute
  - name: "Session.execute"
    kind: SqlQuery
    package: "sqlalchemy.orm"
    description: "SQLAlchemy session execute"
    argument: 0

  - name: "session.execute"
    kind: SqlQuery
    description: "SQLAlchemy session execute"
    argument: 0

  - name: "engine.execute"
    kind: SqlQuery
    description: "SQLAlchemy engine execute"
    argument: 0

  - name: "Engine.execute"
    kind: SqlQuery
    package: "sqlalchemy"
    description: "SQLAlchemy engine execute"
    argument: 0

  # SQLAlchemy Core
  - name: "Connection.execute"
    kind: SqlQuery
    package: "sqlalchemy"
    description: "SQLAlchemy connection execute"
    argument: 0

  - name: "conn.execute"
    kind: SqlQuery
    description: "SQLAlchemy connection execute"
    argument: 0

  # SQLAlchemy ORM query filter (unsafe with string format)
  - name: "filter"
    kind: SqlQuery
    package: "sqlalchemy.orm.Query"
    description: "SQLAlchemy query filter (unsafe with string concat)"
    argument: 0

  - name: "order_by"
    kind: SqlQuery
    package: "sqlalchemy.orm.Query"
    description: "SQLAlchemy order by"
    argument: 0

  - name: "group_by"
    kind: SqlQuery
    package: "sqlalchemy.orm.Query"
    description: "SQLAlchemy group by"
    argument: 0

# =============================================================================
# FastAPI Framework
# =============================================================================

additional_sources_fastapi:
  # FastAPI dependency injection sources
  - name: "Body"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI request body"

  - name: "Query"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI query parameter"

  - name: "Path"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI path parameter"

  - name: "Header"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI header"

  - name: "Cookie"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI cookie"

  - name: "Form"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI form data"

  - name: "File"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI uploaded file"

  - name: "UploadFile"
    kind: UserInput
    package: "fastapi"
    description: "FastAPI upload file"

  # FastAPI Request object
  - name: "Request.json"
    kind: UserInput
    description: "FastAPI request JSON"

  - name: "Request.body"
    kind: UserInput
    description: "FastAPI request body"

  - name: "Request.form"
    kind: UserInput
    description: "FastAPI request form"

  - name: "Request.query_params"
    kind: UserInput
    description: "FastAPI query params"

  - name: "Request.path_params"
    kind: UserInput
    description: "FastAPI path params"

  - name: "Request.headers"
    kind: UserInput
    description: "FastAPI headers"

  - name: "Request.cookies"
    kind: UserInput
    description: "FastAPI cookies"

# =============================================================================
# Pydantic Models (FastAPI input validation)
# =============================================================================

additional_sources_pydantic:
  # Pydantic BaseModel attributes (contain user input after validation)
  - name: "BaseModel"
    kind: UserInput
    package: "pydantic"
    description: "Pydantic model (contains user input)"

  # Pydantic model access
  - name: "model.dict"
    kind: UserInput
    description: "Pydantic model to dict"

  - name: "model.json"
    kind: UserInput
    description: "Pydantic model to JSON"

# =============================================================================
# aiohttp Framework
# =============================================================================

additional_sources_aiohttp:
  # aiohttp request sources
  - name: "request.json"
    kind: UserInput
    description: "aiohttp request JSON"

  - name: "request.post"
    kind: UserInput
    description: "aiohttp POST data"

  - name: "request.query"
    kind: UserInput
    description: "aiohttp query params"

  - name: "request.match_info"
    kind: UserInput
    description: "aiohttp URL match info"

  - name: "request.headers"
    kind: UserInput
    description: "aiohttp headers"

  - name: "request.cookies"
    kind: UserInput
    description: "aiohttp cookies"

  - name: "request.content"
    kind: UserInput
    description: "aiohttp request content"

  - name: "request.text"
    kind: UserInput
    description: "aiohttp request text"

# =============================================================================
# Celery Task Arguments
# =============================================================================

additional_sources_celery:
  # Celery task arguments can contain user data
  - name: "self.request.args"
    kind: UserInput
    description: "Celery task arguments"

  - name: "self.request.kwargs"
    kind: UserInput
    description: "Celery task keyword arguments"

# =============================================================================
# boto3 AWS SDK
# =============================================================================

additional_sources_boto3:
  # S3 object content (may be user-controlled)
  - name: "get_object"
    kind: Network
    package: "boto3.client('s3')"
    description: "S3 get object response"

  - name: "download_file"
    kind: Network
    package: "boto3.client('s3')"
    description: "S3 download file"

  # DynamoDB scan/query results
  - name: "scan"
    kind: Database
    package: "boto3.client('dynamodb')"
    description: "DynamoDB scan results"

  - name: "query"
    kind: Database
    package: "boto3.client('dynamodb')"
    description: "DynamoDB query results"

# =============================================================================
# Jinja2 Template Injection
# =============================================================================

additional_sinks_jinja2:
  # Jinja2 template from string (template injection risk)
  - name: "Template"
    kind: CodeEval
    package: "jinja2"
    description: "Jinja2 template from string"
    argument: 0

  - name: "Environment.from_string"
    kind: CodeEval
    package: "jinja2"
    description: "Jinja2 template from string"
    argument: 0

  - name: "from_string"
    kind: CodeEval
    package: "jinja2.Environment"
    description: "Jinja2 template from string"
    argument: 0

# =============================================================================
# Additional Sanitizers
# =============================================================================

additional_sanitizers:
  # Path sanitization
  - name: "os.path.basename"
    sanitizes: [Path]
    description: "Extract basename (prevents traversal)"

  - name: "os.path.realpath"
    sanitizes: [Path]
    description: "Resolve to real path"

  - name: "os.path.abspath"
    sanitizes: [Path]
    description: "Get absolute path"

  - name: "pathlib.Path.resolve"
    sanitizes: [Path]
    description: "Resolve path"

  - name: "pathlib.Path.name"
    sanitizes: [Path]
    description: "Get path name component"

  # SQL sanitization (Django)
  - name: "django.db.connection.cursor"
    sanitizes: [Sql]
    description: "Django database cursor with parameterization"

  # HTML sanitization
  - name: "django.utils.html.escape"
    sanitizes: [Html]
    description: "Django HTML escape"

  - name: "django.utils.html.conditional_escape"
    sanitizes: [Html]
    description: "Django conditional HTML escape"
