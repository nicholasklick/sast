# Ruby Core Taint Configuration
# Base sources, sinks, and sanitizers for Ruby applications

sources:
  # Standard input
  - name: "gets"
    kind: UserInput
    description: "Read line from stdin"

  - name: "readline"
    kind: UserInput
    description: "Read line from stdin"

  - name: "readlines"
    kind: UserInput
    description: "Read all lines from stdin"

  - name: "STDIN.read"
    kind: UserInput
    description: "Read from stdin"

  - name: "STDIN.gets"
    kind: UserInput
    description: "Read line from stdin"

  # Rails - params hash (primary user input)
  - name: "params"
    kind: UserInput
    description: "Rails params hash"

  - name: "params[]"
    kind: UserInput
    description: "Rails params access"

  - name: "request.params"
    kind: UserInput
    description: "Rails request params"

  - name: "request.parameters"
    kind: UserInput
    description: "Rails request parameters"

  # Rails - request object
  - name: "request.body"
    kind: UserInput
    description: "Rails request body"

  - name: "request.raw_post"
    kind: UserInput
    description: "Rails raw POST body"

  - name: "request.query_string"
    kind: UserInput
    description: "Rails query string"

  - name: "request.query_parameters"
    kind: UserInput
    description: "Rails query parameters"

  - name: "request.request_parameters"
    kind: UserInput
    description: "Rails request parameters"

  - name: "request.path"
    kind: UserInput
    description: "Rails request path"

  - name: "request.fullpath"
    kind: UserInput
    description: "Rails full request path"

  - name: "request.original_url"
    kind: UserInput
    description: "Rails original URL"

  - name: "request.url"
    kind: UserInput
    description: "Rails request URL"

  - name: "request.host"
    kind: UserInput
    description: "Rails request host"

  - name: "request.remote_ip"
    kind: UserInput
    description: "Rails remote IP"

  - name: "request.remote_addr"
    kind: UserInput
    description: "Rails remote address"

  # Rails - headers
  - name: "request.headers"
    kind: UserInput
    description: "Rails request headers"

  - name: "request.headers[]"
    kind: UserInput
    description: "Rails request header access"

  - name: "request.env"
    kind: UserInput
    description: "Rails request environment"

  - name: "request.user_agent"
    kind: UserInput
    description: "Rails user agent"

  - name: "request.referer"
    kind: UserInput
    description: "Rails referer header"

  - name: "request.referrer"
    kind: UserInput
    description: "Rails referrer header"

  - name: "request.content_type"
    kind: UserInput
    description: "Rails content type"

  # Rails - cookies
  - name: "cookies"
    kind: UserInput
    description: "Rails cookies hash"

  - name: "cookies[]"
    kind: UserInput
    description: "Rails cookie access"

  - name: "request.cookies"
    kind: UserInput
    description: "Rails request cookies"

  - name: "session"
    kind: UserInput
    description: "Rails session (may contain user data)"

  - name: "session[]"
    kind: UserInput
    description: "Rails session access"

  # Sinatra
  - name: "request.POST"
    kind: UserInput
    description: "Sinatra POST params"

  - name: "request.GET"
    kind: UserInput
    description: "Sinatra GET params"

  # Environment
  - name: "ENV"
    kind: Environment
    description: "Environment variable access"

  - name: "ENV[]"
    kind: Environment
    description: "Environment variable access"

  - name: "ENV.fetch"
    kind: Environment
    description: "Environment variable fetch"

  # File I/O
  - name: "read"
    kind: File
    package: "File"
    description: "Read file contents"

  - name: "readlines"
    kind: File
    package: "File"
    description: "Read file lines"

  - name: "open"
    kind: File
    package: "File"
    description: "Open file"

  - name: "File.read"
    kind: File
    description: "Read file contents"

  - name: "File.open"
    kind: File
    description: "Open file"

  - name: "File.binread"
    kind: File
    description: "Read binary file"

  - name: "IO.read"
    kind: File
    description: "Read from IO"

  # Network
  - name: "Net::HTTP.get"
    kind: Network
    description: "HTTP GET request"

  - name: "RestClient.get"
    kind: Network
    description: "RestClient GET"

  - name: "HTTParty.get"
    kind: Network
    description: "HTTParty GET"

  - name: "Faraday.get"
    kind: Network
    description: "Faraday GET"

sinks:
  # Command Injection
  - name: "system"
    kind: CommandExecution
    description: "Execute system command"
    argument: 0

  - name: "exec"
    kind: CommandExecution
    description: "Execute and replace process"
    argument: 0

  - name: "`"
    kind: CommandExecution
    description: "Backtick command execution"

  - name: "spawn"
    kind: CommandExecution
    description: "Spawn subprocess"
    argument: 0

  - name: "popen"
    kind: CommandExecution
    package: "IO"
    description: "Open pipe to command"
    argument: 0

  - name: "Open3.capture2"
    kind: CommandExecution
    description: "Capture command output"
    argument: 0

  - name: "Open3.capture3"
    kind: CommandExecution
    description: "Capture command output and error"
    argument: 0

  # SQL Injection
  - name: "execute"
    kind: SqlQuery
    description: "Execute SQL"
    argument: 0

  - name: "exec_query"
    kind: SqlQuery
    description: "Execute SQL query"
    argument: 0

  - name: "select_all"
    kind: SqlQuery
    description: "Select all with SQL"
    argument: 0

  - name: "find_by_sql"
    kind: SqlQuery
    description: "Find by raw SQL"
    argument: 0

  # Helper SQL sinks (common in benchmarks)
  - name: "execute_raw"
    kind: SqlQuery
    description: "Execute raw SQL"
    argument: 0

  - name: "Database.execute_raw"
    kind: SqlQuery
    description: "Database execute raw SQL"
    argument: 0

  - name: "Helpers::Database.execute_raw"
    kind: SqlQuery
    description: "Helper database execute raw"
    argument: 0

  # File operations
  - name: "write"
    kind: FileWrite
    package: "File"
    description: "Write to file"

  - name: "open"
    kind: PathTraversal
    package: "File"
    description: "Open file (path traversal risk)"
    argument: 0

  # Code Injection
  - name: "eval"
    kind: CodeEval
    description: "Evaluate Ruby code"
    argument: 0

  - name: "instance_eval"
    kind: CodeEval
    description: "Evaluate in instance context"
    argument: 0

  - name: "class_eval"
    kind: CodeEval
    description: "Evaluate in class context"
    argument: 0

  - name: "module_eval"
    kind: CodeEval
    description: "Evaluate in module context"
    argument: 0

  # Deserialization
  - name: "load"
    kind: Deserialization
    package: "Marshal"
    description: "Unmarshal Ruby object"
    argument: 0

  - name: "load"
    kind: Deserialization
    package: "YAML"
    description: "Load YAML (unsafe)"
    argument: 0

  - name: "unsafe_load"
    kind: Deserialization
    package: "YAML"
    description: "Unsafe YAML load"
    argument: 0

  # XSS - Only clearly dangerous methods
  # Note: "render" is NOT included because render plain:/json: are safe
  # Only render html: is dangerous, but we can't distinguish without arg analysis
  - name: "raw"
    kind: HtmlOutput
    description: "Output raw HTML (bypasses escaping)"
    argument: 0

  - name: "html_safe"
    kind: HtmlOutput
    description: "Mark string as safe HTML"

  # XPath Injection - Nokogiri
  - name: "xpath"
    kind: XPathQuery
    package: "Nokogiri"
    description: "Nokogiri XPath query"
    argument: 0

  - name: "at_xpath"
    kind: XPathQuery
    package: "Nokogiri"
    description: "Nokogiri XPath query (single node)"
    argument: 0

  - name: "css"
    kind: XPathQuery
    package: "Nokogiri"
    description: "Nokogiri CSS selector (converted to XPath)"
    argument: 0

  - name: "at_css"
    kind: XPathQuery
    package: "Nokogiri"
    description: "Nokogiri CSS selector (single node)"
    argument: 0

  - name: "search"
    kind: XPathQuery
    package: "Nokogiri"
    description: "Nokogiri search (XPath or CSS)"
    argument: 0

  - name: "at"
    kind: XPathQuery
    package: "Nokogiri"
    description: "Nokogiri at (XPath or CSS, single node)"
    argument: 0

  # Open Redirect
  - name: "redirect_to"
    kind: Redirect
    description: "Rails redirect"
    argument: 0

  - name: "redirect"
    kind: Redirect
    description: "Sinatra redirect"
    argument: 0

  # net-ldap LDAP Injection Sinks
  # Note: Generic "search" removed because it conflicts with Nokogiri XPath search
  - name: "ldap.search"
    kind: LdapQuery
    description: "LDAP search"
    argument: 0

  - name: "Net::LDAP.search"
    kind: LdapQuery
    description: "Net::LDAP search"
    argument: 0

  - name: "bind_as"
    kind: LdapQuery
    package: "Net::LDAP"
    description: "LDAP bind as"
    argument: 0

  - name: "ldap.bind_as"
    kind: LdapQuery
    description: "LDAP bind as"
    argument: 0

  # Benchmark helper LDAP sinks - filter is argument 1
  - name: "LdapMock.search"
    kind: LdapQuery
    description: "Mock LDAP search (filter at arg 1)"
    argument: 1

  - name: "Helpers::LdapMock.search"
    kind: LdapQuery
    description: "Helper mock LDAP search (filter at arg 1)"
    argument: 1

  # Path Traversal Sinks
  - name: "File.read"
    kind: PathTraversal
    description: "Read file (path traversal risk)"
    argument: 0

  - name: "File.open"
    kind: PathTraversal
    description: "Open file (path traversal risk)"
    argument: 0

  - name: "File.binread"
    kind: PathTraversal
    description: "Read binary file"
    argument: 0

  - name: "send_file"
    kind: PathTraversal
    description: "Rails send_file (path traversal risk)"
    argument: 0

  # XXE Sinks
  - name: "Nokogiri::XML"
    kind: XmlParse
    description: "Nokogiri XML parsing (XXE risk)"
    argument: 0

  - name: "REXML::Document.new"
    kind: XmlParse
    description: "REXML document parsing (XXE risk)"
    argument: 0

  # Trust Boundary
  - name: "session[]="
    kind: TrustBoundary
    description: "Store value in session"
    argument: 1

sanitizers:
  # HTML sanitization
  - name: "sanitize"
    sanitizes: [Html]
    description: "Rails HTML sanitizer"

  - name: "strip_tags"
    sanitizes: [Html]
    description: "Strip HTML tags"

  - name: "h"
    sanitizes: [Html]
    description: "Rails HTML escape helper"

  - name: "html_escape"
    sanitizes: [Html]
    description: "HTML escape"

  - name: "ERB::Util.html_escape"
    sanitizes: [Html]
    description: "ERB HTML escape"

  - name: "CGI.escapeHTML"
    sanitizes: [Html]
    description: "CGI HTML escape"

  # SQL sanitization
  - name: "sanitize_sql"
    sanitizes: [Sql]
    description: "Rails SQL sanitizer"

  - name: "quote"
    sanitizes: [Sql]
    description: "SQL quoting"

  # Shell sanitization
  - name: "shellescape"
    sanitizes: [Shell]
    package: "Shellwords"
    description: "Shell escape"

  - name: "escape"
    sanitizes: [Shell]
    package: "Shellwords"
    description: "Shell escape"

  # Path sanitization
  - name: "basename"
    sanitizes: [Path]
    package: "File"
    description: "Extract basename (prevents traversal)"

  - name: "realpath"
    sanitizes: [Path]
    package: "File"
    description: "Resolve to real path"

  # Validation
  - name: "to_i"
    sanitizes: [All]
    description: "Convert to integer"

  - name: "to_f"
    sanitizes: [All]
    description: "Convert to float"

summaries:
  # String operations
  - name: "+"
    package: "String"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "concat"
    package: "String"
    input: "Argument[0]"
    output: "Argument[this]"
    kind: taint

  - name: "<<"
    package: "String"
    input: "Argument[0]"
    output: "Argument[this]"
    kind: taint

  - name: "downcase"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "upcase"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "strip"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "gsub"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "sub"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "split"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  # Array/Hash access
  - name: "[]"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "[]"
    package: "Hash"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "first"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "last"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  # JSON parsing - taint flows from input to parsed object
  - name: "parse"
    package: "JSON"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "JSON.parse"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "load"
    package: "JSON"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # YAML safe_load is safer but still propagates taint
  - name: "safe_load"
    package: "YAML"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "YAML.safe_load"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # XML parsing
  - name: "parse"
    package: "Nokogiri"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "Nokogiri::XML"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "Nokogiri::HTML"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

# =============================================================================
# Rails Extended - Code Injection Sinks
# =============================================================================

additional_sinks_code_injection:
  # send/public_send - dangerous if method name is user-controlled
  - name: "send"
    kind: CodeEval
    description: "Dynamic method invocation (code injection if method name is tainted)"
    argument: 0

  - name: "public_send"
    kind: CodeEval
    description: "Public dynamic method invocation"
    argument: 0

  - name: "__send__"
    kind: CodeEval
    description: "Direct dynamic method invocation"
    argument: 0

  # constantize - converts string to constant (dangerous)
  - name: "constantize"
    kind: CodeEval
    description: "Convert string to constant (code injection risk)"

  - name: "safe_constantize"
    kind: CodeEval
    description: "Safe constantize (still risky with user input)"

  # classify/camelize followed by constantize
  - name: "classify"
    kind: CodeEval
    description: "Convert to class name string"

# =============================================================================
# Rails Template Injection
# =============================================================================

additional_sinks_template:
  # ERB template injection
  - name: "ERB.new"
    kind: CodeEval
    description: "ERB template creation (template injection risk)"
    argument: 0

  - name: "Erubi::Engine.new"
    kind: CodeEval
    description: "Erubi template creation"
    argument: 0

  - name: "Haml::Engine.new"
    kind: CodeEval
    description: "Haml template creation"
    argument: 0

  - name: "Slim::Template.new"
    kind: CodeEval
    description: "Slim template creation"
    argument: 0

  # render with inline template
  - name: "render inline:"
    kind: CodeEval
    description: "Render inline template (injection risk)"

# =============================================================================
# ActiveRecord Extended - SQL Injection
# =============================================================================

additional_sinks_activerecord:
  # ActiveRecord dynamic finders (can be vulnerable)
  - name: "where"
    kind: SqlQuery
    description: "ActiveRecord where clause (unsafe with string interpolation)"
    argument: 0

  - name: "order"
    kind: SqlQuery
    description: "ActiveRecord order clause"
    argument: 0

  - name: "group"
    kind: SqlQuery
    description: "ActiveRecord group clause"
    argument: 0

  - name: "having"
    kind: SqlQuery
    description: "ActiveRecord having clause"
    argument: 0

  - name: "joins"
    kind: SqlQuery
    description: "ActiveRecord joins clause"
    argument: 0

  - name: "select"
    kind: SqlQuery
    description: "ActiveRecord select clause"
    argument: 0

  - name: "from"
    kind: SqlQuery
    description: "ActiveRecord from clause"
    argument: 0

  - name: "pluck"
    kind: SqlQuery
    description: "ActiveRecord pluck (unsafe if column name is user input)"
    argument: 0

  - name: "calculate"
    kind: SqlQuery
    description: "ActiveRecord calculate"
    argument: 0

  - name: "count"
    kind: SqlQuery
    description: "ActiveRecord count (unsafe with string argument)"
    argument: 0

  - name: "sum"
    kind: SqlQuery
    description: "ActiveRecord sum"
    argument: 0

  - name: "average"
    kind: SqlQuery
    description: "ActiveRecord average"
    argument: 0

  - name: "minimum"
    kind: SqlQuery
    description: "ActiveRecord minimum"
    argument: 0

  - name: "maximum"
    kind: SqlQuery
    description: "ActiveRecord maximum"
    argument: 0

  # Dangerous raw SQL methods
  - name: "connection.execute"
    kind: SqlQuery
    description: "Execute raw SQL on connection"
    argument: 0

  - name: "execute_raw"
    kind: SqlQuery
    description: "Execute raw SQL"
    argument: 0

  - name: "update_all"
    kind: SqlQuery
    description: "Update all with SQL (injection risk)"
    argument: 0

  - name: "delete_all"
    kind: SqlQuery
    description: "Delete all with SQL (injection risk)"
    argument: 0

# =============================================================================
# Rack Environment Sources
# =============================================================================

additional_sources_rack:
  # Rack environment (often missed)
  - name: "env['rack.input']"
    kind: UserInput
    description: "Rack input stream"

  - name: "env['QUERY_STRING']"
    kind: UserInput
    description: "Rack query string"

  - name: "env['PATH_INFO']"
    kind: UserInput
    description: "Rack path info"

  - name: "env['REQUEST_URI']"
    kind: UserInput
    description: "Rack request URI"

  - name: "env['HTTP_HOST']"
    kind: UserInput
    description: "Rack HTTP host"

  - name: "env['HTTP_REFERER']"
    kind: UserInput
    description: "Rack HTTP referer"

  - name: "env['HTTP_USER_AGENT']"
    kind: UserInput
    description: "Rack HTTP user agent"

  - name: "env['HTTP_COOKIE']"
    kind: UserInput
    description: "Rack HTTP cookie"

  - name: "env['CONTENT_TYPE']"
    kind: UserInput
    description: "Rack content type"

  - name: "env['REMOTE_ADDR']"
    kind: UserInput
    description: "Rack remote address"

# =============================================================================
# ActionController Parameters
# =============================================================================

additional_sources_params:
  # Unsafe parameter access
  - name: "to_unsafe_h"
    kind: UserInput
    package: "ActionController::Parameters"
    description: "Convert params to unsafe hash"

  - name: "to_unsafe_hash"
    kind: UserInput
    package: "ActionController::Parameters"
    description: "Convert params to unsafe hash"

  - name: "permit!"
    kind: UserInput
    package: "ActionController::Parameters"
    description: "Permit all parameters (dangerous)"

# =============================================================================
# Sidekiq Job Arguments
# =============================================================================

additional_sources_sidekiq:
  # Sidekiq job arguments can contain user data
  - name: "perform"
    kind: UserInput
    description: "Sidekiq job perform arguments"

  - name: "perform_async"
    kind: UserInput
    description: "Sidekiq async job arguments"

# =============================================================================
# Devise Authentication
# =============================================================================

additional_sources_devise:
  # Devise authentication
  - name: "current_user"
    kind: Database
    description: "Current authenticated user (database record)"

  - name: "user_signed_in?"
    kind: Database
    description: "User authentication check"

# =============================================================================
# Additional Sanitizers
# =============================================================================

additional_sanitizers:
  # Rack sanitization
  - name: "Rack::Utils.escape_html"
    sanitizes: [Html]
    description: "Rack HTML escape"

  - name: "Rack::Utils.escape"
    sanitizes: [Path]
    description: "Rack URL escape"

  # ActiveSupport sanitization
  - name: "ActiveSupport::SafeBuffer"
    sanitizes: [Html]
    description: "Rails safe buffer"

  # File path sanitization
  - name: "File.basename"
    sanitizes: [Path]
    description: "Extract file basename"

  - name: "Pathname.new"
    sanitizes: [Path]
    description: "Create pathname object"

# =============================================================================
# net-ldap LDAP Injection Sinks
# =============================================================================

additional_sinks_ldap:
  - name: "search"
    kind: LdapQuery
    package: "Net::LDAP"
    description: "LDAP search"
    argument: 0

  - name: "ldap.search"
    kind: LdapQuery
    description: "LDAP search"
    argument: 0

  - name: "Net::LDAP.search"
    kind: LdapQuery
    description: "Net::LDAP search"
    argument: 0

  - name: "bind_as"
    kind: LdapQuery
    package: "Net::LDAP"
    description: "LDAP bind as (authentication with filter)"
    argument: 0

  - name: "ldap.bind_as"
    kind: LdapQuery
    description: "LDAP bind as"
    argument: 0

  - name: "LdapMock.search"
    kind: LdapQuery
    description: "LDAP mock search"
    argument: 1

  - name: "Helpers::LdapMock.search"
    kind: LdapQuery
    description: "Helper LDAP search"
    argument: 1

# =============================================================================
# Trust Boundary - Session Storage
# =============================================================================

additional_sinks_trustboundary:
  - name: "session[]="
    kind: TrustBoundary
    description: "Store value in session"
    argument: 1

  - name: "session.store"
    kind: TrustBoundary
    description: "Store session value"
    argument: 1

  - name: "cookies[]="
    kind: TrustBoundary
    description: "Store value in cookie"
    argument: 1

# =============================================================================
# Path Traversal Sinks
# =============================================================================

additional_sinks_pathtraversal:
  - name: "File.read"
    kind: PathTraversal
    description: "Read file (path traversal risk)"
    argument: 0

  - name: "File.open"
    kind: PathTraversal
    description: "Open file (path traversal risk)"
    argument: 0

  - name: "File.write"
    kind: FileWrite
    description: "Write file"
    argument: 0

  - name: "File.binread"
    kind: PathTraversal
    description: "Read binary file"
    argument: 0

  - name: "File.readlines"
    kind: PathTraversal
    description: "Read file lines"
    argument: 0

  - name: "send_file"
    kind: PathTraversal
    description: "Rails send_file (path traversal risk)"
    argument: 0

  - name: "send_data"
    kind: PathTraversal
    description: "Rails send_data with filename"

# =============================================================================
# XXE Sinks
# =============================================================================

additional_sinks_xxe:
  - name: "Nokogiri::XML"
    kind: XmlParse
    description: "Nokogiri XML parsing (XXE risk with external entities)"
    argument: 0

  - name: "REXML::Document.new"
    kind: XmlParse
    description: "REXML document parsing (XXE risk)"
    argument: 0

  - name: "LibXML::XML::Parser.string"
    kind: XmlParse
    description: "LibXML parsing (XXE risk)"
    argument: 0
