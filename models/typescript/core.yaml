# TypeScript Core Taint Configuration
# Extends JavaScript core with TypeScript-specific patterns
# Note: TypeScript shares the same runtime as JavaScript

# Import JavaScript core
# _extends: javascript/core.yaml

sources:
  # Command Line (Node.js)
  - name: "process.argv"
    kind: UserInput
    description: "Command line arguments"

  - name: "process.env"
    kind: Environment
    description: "Environment variables"

  # HTTP - Express (typed)
  - name: "req.body"
    kind: UserInput
    description: "Express request body"

  - name: "req.query"
    kind: UserInput
    description: "Express query parameters"

  - name: "req.params"
    kind: UserInput
    description: "Express route parameters"

  - name: "req.headers"
    kind: UserInput
    description: "Express request headers"

  - name: "req.cookies"
    kind: UserInput
    description: "Express cookies"

  - name: "request.body"
    kind: UserInput
    description: "Request body"

  - name: "request.query"
    kind: UserInput
    description: "Request query parameters"

  - name: "request.params"
    kind: UserInput
    description: "Request route parameters"

  # HTTP - NestJS
  - name: "@Body"
    kind: UserInput
    description: "NestJS body decorator"

  - name: "@Query"
    kind: UserInput
    description: "NestJS query decorator"

  - name: "@Param"
    kind: UserInput
    description: "NestJS param decorator"

  - name: "@Headers"
    kind: UserInput
    description: "NestJS headers decorator"

  # HTTP - Koa (typed)
  - name: "ctx.request.body"
    kind: UserInput
    description: "Koa request body"

  - name: "ctx.request.query"
    kind: UserInput
    description: "Koa query parameters"

  - name: "ctx.params"
    kind: UserInput
    description: "Koa route parameters"

  # Browser DOM
  - name: "document.location"
    kind: UserInput
    description: "Document location"

  - name: "window.location"
    kind: UserInput
    description: "Window location"

  - name: "location.search"
    kind: UserInput
    description: "URL query string"

  - name: "location.hash"
    kind: UserInput
    description: "URL hash fragment"

  # File I/O (Node.js)
  - name: "fs.readFile"
    kind: File
    description: "Read file async"

  - name: "fs.readFileSync"
    kind: File
    description: "Read file sync"

  - name: "fs.promises.readFile"
    kind: File
    description: "Read file promise"

sinks:
  # Command Execution
  - name: "exec"
    kind: CommandExecution
    package: "child_process"
    description: "Execute shell command"
    argument: 0

  - name: "execSync"
    kind: CommandExecution
    package: "child_process"
    description: "Execute shell command sync"
    argument: 0

  - name: "spawn"
    kind: CommandExecution
    package: "child_process"
    description: "Spawn process"
    argument: 0

  - name: "child_process.exec"
    kind: CommandExecution
    description: "Execute shell command"
    argument: 0

  # Code Injection
  - name: "eval"
    kind: CodeEval
    description: "Evaluate JavaScript code"
    argument: 0

  - name: "Function"
    kind: CodeEval
    description: "Dynamic function constructor"
    argument: 0

  - name: "new Function"
    kind: CodeEval
    description: "New Function constructor"
    argument: 0

  # SQL Injection (TypeORM, Prisma, etc.)
  - name: "query"
    kind: SqlQuery
    description: "Database query"
    argument: 0

  - name: "execute"
    kind: SqlQuery
    description: "Execute SQL"
    argument: 0

  - name: "raw"
    kind: SqlQuery
    description: "Raw SQL query"
    argument: 0

  - name: "$queryRaw"
    kind: SqlQuery
    package: "prisma"
    description: "Prisma raw query"
    argument: 0

  - name: "$executeRaw"
    kind: SqlQuery
    package: "prisma"
    description: "Prisma execute raw"
    argument: 0

  - name: "createQueryBuilder"
    kind: SqlQuery
    package: "typeorm"
    description: "TypeORM query builder"
    argument: 0

  # SQL Injection - Sequelize
  - name: "sequelize.query"
    kind: SqlQuery
    package: "sequelize"
    description: "Sequelize raw query"
    argument: 0

  - name: "sequelize.literal"
    kind: SqlQuery
    package: "sequelize"
    description: "Sequelize literal SQL"
    argument: 0

  - name: "Sequelize.literal"
    kind: SqlQuery
    description: "Sequelize literal SQL"
    argument: 0

  # SQL Injection - Knex
  - name: "knex.raw"
    kind: SqlQuery
    description: "Knex raw query"
    argument: 0

  - name: "whereRaw"
    kind: SqlQuery
    description: "Knex whereRaw"
    argument: 0

  # NoSQL Injection - MongoDB
  - name: "find"
    kind: SqlQuery
    description: "MongoDB find"
    argument: 0

  - name: "findOne"
    kind: SqlQuery
    description: "MongoDB findOne"
    argument: 0

  - name: "aggregate"
    kind: SqlQuery
    description: "MongoDB aggregate"
    argument: 0

  - name: "findOneAndUpdate"
    kind: SqlQuery
    description: "MongoDB findOneAndUpdate"
    argument: 0

  - name: "updateOne"
    kind: SqlQuery
    description: "MongoDB updateOne"
    argument: 0

  - name: "$where"
    kind: CodeEval
    description: "MongoDB $where allows JS execution"
    argument: 0

  # File operations
  - name: "fs.writeFile"
    kind: FileWrite
    description: "Write file async"
    argument: 0

  - name: "fs.writeFileSync"
    kind: FileWrite
    description: "Write file sync"
    argument: 0

  - name: "fs.promises.writeFile"
    kind: FileWrite
    description: "Write file promise"
    argument: 0

  - name: "fs.readFile"
    kind: PathTraversal
    description: "Read file (path traversal risk)"
    argument: 0

  # XSS - DOM
  - name: "innerHTML"
    kind: HtmlOutput
    description: "Set inner HTML"

  - name: "outerHTML"
    kind: HtmlOutput
    description: "Set outer HTML"

  - name: "document.write"
    kind: HtmlOutput
    description: "Document write"
    argument: 0

  # XSS - Server response
  - name: "res.send"
    kind: HtmlOutput
    description: "Express send response"
    argument: 0

  - name: "res.write"
    kind: HtmlOutput
    description: "Response write"
    argument: 0

  # XSS - React (dangerouslySetInnerHTML)
  - name: "dangerouslySetInnerHTML"
    kind: HtmlOutput
    description: "React dangerous inner HTML"

  # LDAP Injection
  - name: "ldapMock.search"
    kind: LdapQuery
    description: "LDAP search with filter"
    argument: 1

  - name: "ldap.search"
    kind: LdapQuery
    description: "LDAP search with filter"
    argument: 1

  - name: "client.search"
    kind: LdapQuery
    description: "LDAP client search"
    argument: 1

  # Open Redirect
  - name: "res.redirect"
    kind: Redirect
    description: "Express redirect"
    argument: 0

  - name: "response.redirect"
    kind: Redirect
    description: "HTTP response redirect"
    argument: 0

sanitizers:
  # HTML sanitization
  - name: "escape"
    sanitizes: [Html]
    description: "Generic escape"

  - name: "sanitize"
    sanitizes: [Html]
    description: "Generic sanitize"

  - name: "DOMPurify.sanitize"
    sanitizes: [Html]
    description: "DOMPurify HTML sanitizer"

  - name: "validator.escape"
    sanitizes: [Html]
    description: "Validator.js escape"

  - name: "xss"
    sanitizes: [Html]
    description: "XSS filter"

  # Type coercion (TypeScript type guards)
  - name: "parseInt"
    sanitizes: [All]
    description: "Parse integer"

  - name: "parseFloat"
    sanitizes: [All]
    description: "Parse float"

  - name: "Number"
    sanitizes: [All]
    description: "Convert to number"

  # URL encoding
  - name: "encodeURIComponent"
    sanitizes: [Path]
    description: "URL encode component"

  - name: "encodeURI"
    sanitizes: [Path]
    description: "URL encode"

  # Path traversal sanitizers
  - name: "path.basename"
    sanitizes: [Path]
    description: "Extract filename only - prevents directory traversal"

  - name: "basename"
    sanitizes: [Path]
    description: "Extract filename only - prevents directory traversal"

  # Custom/OWASP sanitizers
  - name: "escapeForHtml"
    sanitizes: [Html]
    description: "OWASP benchmark HTML escape utility"

  - name: "escapeHtml"
    sanitizes: [Html]
    description: "HTML escape function"

  - name: "htmlEscape"
    sanitizes: [Html]
    description: "HTML escape function"

summaries:
  # String operations
  - name: "+"
    package: "String"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "concat"
    package: "String"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  - name: "toLowerCase"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "toUpperCase"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "trim"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "split"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "replace"
    package: "String"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  # Template literal interpolation
  - name: "template_literal"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # Array access
  - name: "[]"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "join"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "map"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  - name: "filter"
    package: "Array"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: taint

  # JSON
  - name: "JSON.parse"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: value

  - name: "JSON.stringify"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: taint

  # URL decoding
  - name: "decodeURIComponent"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: value

  # Base64 (Node.js Buffer)
  - name: "Buffer.from"
    input: "Argument[0]"
    output: "ReturnValue"
    kind: value

  - name: "toString"
    package: "Buffer"
    input: "Argument[this]"
    output: "ReturnValue"
    kind: value
